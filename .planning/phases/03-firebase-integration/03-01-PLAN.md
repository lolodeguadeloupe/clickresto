---
phase: 03-firebase-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [migrations/001_contacts.sql, index.html]
autonomous: true

must_haves:
  truths:
    - "Form submission sends data to Supabase contacts table"
    - "Button shows loading state while submitting"
    - "Success message replaces form after successful submission"
    - "User can re-submit via 'Envoyer un autre message' button"
    - "Error message appears if submission fails"
    - "Offline warning shown if no connection"
    - "Submission times out after 10 seconds"
    - "Honeypot blocks simple bots"
  artifacts:
    - path: "migrations/001_contacts.sql"
      provides: "Supabase contacts table with constraints and permissions"
      contains: "CREATE TABLE"
    - path: "index.html"
      provides: "Supabase integration, form submission, loading/success/error states"
      contains: "supabase"
  key_links:
    - from: "index.html"
      to: "Supabase REST API"
      via: "supabase-js CDN client .from('contacts').insert()"
      pattern: "from.*contacts.*insert"
    - from: "index.html form submit"
      to: "loading state"
      via: "button disabled + spinner on submit"
      pattern: "disabled|loading"
    - from: "migrations/001_contacts.sql"
      to: "Supabase database"
      via: "SQL executed on Supabase"
      pattern: "GRANT INSERT.*anon"
---

<objective>
Integrate Supabase into the existing contact form to store lead submissions, with loading state, success/error feedback, anti-spam honeypot, and timeout handling.

Purpose: Transform the mock form submission into a real lead capture pipeline that stores contacts in Supabase.
Output: SQL migration file + updated index.html with full Supabase integration.
</objective>

<execution_context>
@/home/laurent/.claude/get-shit-done/workflows/execute-plan.md
@/home/laurent/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-firebase-integration/03-CONTEXT.md
@.planning/phases/03-firebase-integration/03-RESEARCH.md
@.env
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SQL migration for contacts table</name>
  <files>migrations/001_contacts.sql</files>
  <action>
Create `migrations/001_contacts.sql` with the following SQL (from RESEARCH.md):

```sql
CREATE TABLE IF NOT EXISTS contacts (
  id BIGSERIAL PRIMARY KEY,
  nom TEXT NOT NULL,
  email TEXT NOT NULL,
  telephone TEXT NOT NULL,
  etablissement TEXT,
  type TEXT NOT NULL CHECK (type IN ('restaurateur', 'apporteur')),
  message TEXT,
  status TEXT NOT NULL DEFAULT 'nouveau',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

ALTER TABLE contacts ADD CONSTRAINT email_format
  CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$');

ALTER TABLE contacts ADD CONSTRAINT phone_format
  CHECK (telephone ~ '^0[1-9][0-9]{8}$');

ALTER TABLE contacts DISABLE ROW LEVEL SECURITY;

GRANT INSERT ON contacts TO anon;

CREATE INDEX idx_contacts_created_at ON contacts(created_at DESC);
CREATE INDEX idx_contacts_status ON contacts(status);
```

This is a reproducible migration script. The user will run it manually on Supabase SQL Editor.
  </action>
  <verify>File `migrations/001_contacts.sql` exists and contains CREATE TABLE, constraints, GRANT INSERT, and indexes.</verify>
  <done>SQL migration file exists with contacts table definition, email/phone format constraints, RLS disabled, anon INSERT grant, and indexes on created_at and status.</done>
</task>

<task type="auto">
  <name>Task 2: Add Supabase integration and form submission to index.html</name>
  <files>index.html</files>
  <action>
Modify `index.html` with these changes:

**1. Add Supabase CDN script** (before closing `</body>`, before the existing `<script>`):
```html
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
```

**2. Add honeypot field** inside the `<form id="contactForm">`, after the message textarea `<div class="form-group">` and before the submit button. Use a realistic field name:
```html
<div class="hp-field">
  <label for="company_url">Website</label>
  <input type="text" id="company_url" name="company_url" tabindex="-1" autocomplete="off">
</div>
```

**3. Add CSS for honeypot** in the `<style>` section:
```css
.hp-field { position: absolute; left: -9999px; opacity: 0; height: 0; overflow: hidden; }
```

**4. Add CSS for loading and error states** in the `<style>` section:
```css
.btn-loading { opacity: 0.7; pointer-events: none; }
.btn-loading .btn-text { display: none; }
.btn-loading .btn-spinner { display: inline-block; }
.btn-spinner { display: none; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.form-error { display: none; background: var(--primary); color: var(--white); border: 3px solid var(--secondary); border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 1rem; font-weight: 500; }
.form-error.show { display: block; }
```

**5. Update the submit button HTML** — replace the existing submit button:
```html
<button type="submit" class="btn btn-primary" id="submitBtn">
  <span class="btn-text">Envoyer</span>
  <span class="btn-spinner"></span>
</button>
```

**6. Update the success message HTML** — replace the existing `.form-success` div with:
```html
<div class="form-success" id="formSuccess">
  <p>Merci ! Nous vous recontacterons sous 48h.</p>
  <button type="button" class="btn btn-primary" id="resetFormBtn" style="margin-top: 1rem;">
    Envoyer un autre message
  </button>
</div>
```

**7. Add form error container** — add before the `<form>` element inside `.contact-form`:
```html
<div class="form-error" id="formError"></div>
```

**8. Rewrite the `<script>` section** — replace the entire script block. The new script must include:

a) **Mobile menu toggle** — keep the existing mobile menu code exactly as-is.

b) **Toggle button handler** — keep the existing toggle handler exactly as-is.

c) **Supabase client initialization** with obfuscated credentials:
```javascript
// Supabase config (obfuscated)
const _sb = [
  atob('SUPABASE_URL_BASE64'),
  atob('SUPABASE_KEY_BASE64')
];
const { createClient } = supabase;
const sb = createClient(_sb[0], _sb[1]);
```
Read `.env` to get the actual SUPABASE_URL and SUPABASE_KEY values. Base64-encode them using `btoa()` equivalent and put the encoded strings in the code.

d) **Timeout helper**:
```javascript
function withTimeout(promise, ms) {
  return Promise.race([
    promise,
    new Promise((_, reject) => setTimeout(() => reject(new Error('TIMEOUT')), ms))
  ]);
}
```

e) **Form submission handler** — replace the existing mock submit handler with an async handler:
- Check honeypot: if `company_url` has value, silently fake success (show success message without sending)
- Check `navigator.onLine` — if false, show error "Vous semblez être hors ligne. Vérifiez votre connexion et réessayez."
- Show loading state: disable submit button, add `btn-loading` class
- Clear any previous form error
- Run existing validation (keep all validation logic from Phase 2 unchanged)
- If validation passes, collect form data into object: `{ nom, email, telephone: phoneDigitsOnly, etablissement, type, message }`
  - Strip spaces from telephone before sending (DB constraint expects `0XXXXXXXXX` format)
- Call `withTimeout(sb.from('contacts').insert([data]), 10000)`
- On success: hide form (`form.style.display = 'none'`), show success message
- On error:
  - If error.message === 'TIMEOUT': show "Le serveur met trop de temps à répondre. Réessayez dans quelques instants."
  - Otherwise: show "Une erreur est survenue. Veuillez réessayer." with the actual error detail if available
  - Remove loading state from button
- Always remove loading state in finally block

f) **Reset form handler**:
```javascript
document.getElementById('resetFormBtn').addEventListener('click', () => {
  form.reset();
  form.style.display = '';
  formSuccess.classList.remove('show');
  formError.classList.remove('show');
  // Reset type toggle to restaurateur
  toggleBtns[0].click();
});
```

g) **Keep existing showError function and blur handlers** from Phase 2.

IMPORTANT: Preserve ALL existing behavior from Phase 2 (toggle buttons, conditional etablissement required, placeholder changes, error-on-blur clearing, mobile menu). The only change to the form logic is replacing the mock success (lines 681-682) with real Supabase submission.
  </action>
  <verify>
1. Open index.html in browser, check Supabase CDN loads (no console errors about `supabase` being undefined)
2. Check honeypot field is not visible
3. Submit form — verify loading state appears on button
4. Verify network request goes to Supabase URL
5. Check form disappears and success message with "Envoyer un autre message" button appears
6. Click "Envoyer un autre message" — form reappears empty
  </verify>
  <done>
index.html loads supabase-js from CDN, initializes client with obfuscated credentials, submits form data to Supabase contacts table with loading state, 10s timeout, offline detection, honeypot anti-spam, success message with re-submit button, and error handling. All Phase 2 validation and UI behavior preserved.
  </done>
</task>

</tasks>

<verification>
1. `migrations/001_contacts.sql` exists with complete table definition
2. index.html loads supabase-js CDN
3. Supabase credentials are base64-obfuscated in code
4. Honeypot field is hidden via CSS
5. Submit button shows loading spinner during submission
6. Successful submission hides form, shows "Merci ! Nous vous recontacterons sous 48h."
7. "Envoyer un autre message" button resets and re-shows form
8. Failed submission shows error message
9. Offline state shows specific message
10. 10-second timeout shows timeout message
11. All Phase 2 validation still works (required fields, email format, phone format, conditional etablissement)
12. Mobile menu toggle still works
</verification>

<success_criteria>
- Form data successfully inserts into Supabase contacts table
- Loading, success, and error states all render correctly
- Honeypot silently blocks bot submissions
- All Phase 2 form validation and UI behavior unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/03-firebase-integration/03-01-SUMMARY.md`
</output>
