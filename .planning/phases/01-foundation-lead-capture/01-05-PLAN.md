---
phase: 01-foundation-lead-capture
plan: 05
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - backoffice/app/(dashboard)/layout.tsx
  - backoffice/app/(dashboard)/dashboard/page.tsx
  - backoffice/app/(dashboard)/admin/leads/page.tsx
  - backoffice/components/dashboard/LeadsTable.tsx
  - backoffice/components/dashboard/LeadStatusBadge.tsx
  - backoffice/lib/auth.ts
autonomous: true

must_haves:
  truths:
    - "Admin can view list of leads in dashboard"
    - "Admin sees lead details: name, email, phone, restaurant, status, date"
    - "Non-admin users are redirected away from admin pages"
    - "Lead status is displayed with visual indicator"
  artifacts:
    - path: "backoffice/app/(dashboard)/admin/leads/page.tsx"
      provides: "Admin leads dashboard page"
      min_lines: 30
    - path: "backoffice/components/dashboard/LeadsTable.tsx"
      provides: "Reusable leads table component"
      min_lines: 50
    - path: "backoffice/lib/auth.ts"
      provides: "Auth helper functions"
      exports: ["getUser", "getUserRole", "requireAdmin"]
  key_links:
    - from: "backoffice/app/(dashboard)/admin/leads/page.tsx"
      to: "Supabase"
      via: "createClient + select"
      pattern: "from\\(['\"]leads['\"]\\)"
    - from: "backoffice/app/(dashboard)/admin/leads/page.tsx"
      to: "backoffice/lib/auth.ts"
      via: "requireAdmin"
      pattern: "requireAdmin"
---

<objective>
Create the admin dashboard for viewing and managing leads from demo requests.

Purpose: Enable admins to view all submitted leads in a dashboard (ADM-01), with role-based access control (AUTH-04).
Output: Protected admin route with leads table showing all demo requests from the landing page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-lead-capture/01-RESEARCH.md
@.planning/phases/01-foundation-lead-capture/01-01-SUMMARY.md
@.planning/phases/01-foundation-lead-capture/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth helper functions</name>
  <files>
    backoffice/lib/auth.ts
  </files>
  <action>
    Create `backoffice/lib/auth.ts` with helper functions for auth and role checking:

    ```typescript
    import { createClient } from '@/lib/supabase/server'
    import { redirect } from 'next/navigation'
    import { UserRole } from '@/types/database.types'

    export async function getUser() {
      const supabase = await createClient()
      const { data: { user }, error } = await supabase.auth.getUser()

      if (error || !user) {
        return null
      }

      return user
    }

    export async function getUserRole(): Promise<UserRole | null> {
      const supabase = await createClient()

      const { data: { user }, error } = await supabase.auth.getUser()
      if (error || !user) {
        return null
      }

      const { data: roleData, error: roleError } = await supabase
        .from('user_roles')
        .select('role')
        .eq('user_id', user.id)
        .single()

      if (roleError || !roleData) {
        return 'affiliate' // Default role if not found
      }

      return roleData.role as UserRole
    }

    export async function requireAuth() {
      const user = await getUser()

      if (!user) {
        redirect('/login')
      }

      return user
    }

    export async function requireAdmin() {
      const user = await requireAuth()
      const role = await getUserRole()

      if (role !== 'admin') {
        redirect('/dashboard')
      }

      return user
    }

    export async function requireAffiliate() {
      const user = await requireAuth()
      const role = await getUserRole()

      if (role !== 'affiliate' && role !== 'admin') {
        redirect('/login')
      }

      return { user, role }
    }
    ```
  </action>
  <verify>
    ```bash
    cd backoffice && npx tsc --noEmit
    ```
  </verify>
  <done>
    - lib/auth.ts created
    - Exports getUser, getUserRole, requireAuth, requireAdmin, requireAffiliate
    - Uses Server Component patterns (await createClient())
    - Redirects to appropriate pages on auth failure
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard layout and home page</name>
  <files>
    backoffice/app/(dashboard)/layout.tsx
    backoffice/app/(dashboard)/dashboard/page.tsx
    backoffice/components/dashboard/Sidebar.tsx
    backoffice/components/dashboard/Header.tsx
  </files>
  <action>
    Create dashboard layout structure with sidebar navigation.

    **backoffice/app/(dashboard)/layout.tsx:**

    ```tsx
    import { requireAuth } from '@/lib/auth'
    import { Sidebar } from '@/components/dashboard/Sidebar'
    import { Header } from '@/components/dashboard/Header'

    export default async function DashboardLayout({
      children,
    }: {
      children: React.ReactNode
    }) {
      await requireAuth()

      return (
        <div className="min-h-screen bg-gray-50">
          <Sidebar />
          <div className="lg:pl-64">
            <Header />
            <main className="p-6">
              {children}
            </main>
          </div>
        </div>
      )
    }
    ```

    **backoffice/components/dashboard/Sidebar.tsx:**

    ```tsx
    import Link from 'next/link'
    import { getUserRole } from '@/lib/auth'

    export async function Sidebar() {
      const role = await getUserRole()
      const isAdmin = role === 'admin'

      return (
        <aside className="fixed inset-y-0 left-0 z-50 w-64 bg-[#1D3557] text-white transform -translate-x-full lg:translate-x-0 transition-transform">
          <div className="flex items-center h-16 px-6 border-b border-white/10">
            <Link href="/dashboard" className="text-xl font-bold">
              Clickresto
            </Link>
          </div>

          <nav className="p-4 space-y-2">
            <Link
              href="/dashboard"
              className="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors"
            >
              <span>üè†</span>
              <span>Tableau de bord</span>
            </Link>

            {isAdmin && (
              <>
                <div className="pt-4 pb-2 px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">
                  Administration
                </div>
                <Link
                  href="/admin/leads"
                  className="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors"
                >
                  <span>üìã</span>
                  <span>Leads</span>
                </Link>
              </>
            )}

            {!isAdmin && (
              <>
                <div className="pt-4 pb-2 px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">
                  Affiliation
                </div>
                <Link
                  href="/affiliate/referrals"
                  className="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors"
                >
                  <span>üîó</span>
                  <span>Mes parrainages</span>
                </Link>
              </>
            )}
          </nav>
        </aside>
      )
    }
    ```

    **backoffice/components/dashboard/Header.tsx:**

    ```tsx
    import { getUser } from '@/lib/auth'
    import { signOut } from '@/app/actions/auth'

    export async function Header() {
      const user = await getUser()

      return (
        <header className="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6">
          <div className="flex items-center gap-4">
            <button className="lg:hidden text-gray-600">
              ‚ò∞
            </button>
            <h1 className="text-lg font-semibold text-gray-900">
              Espace membre
            </h1>
          </div>

          <div className="flex items-center gap-4">
            <span className="text-sm text-gray-600">
              {user?.email}
            </span>
            <form action={signOut}>
              <button
                type="submit"
                className="text-sm text-[#E63946] hover:underline"
              >
                Deconnexion
              </button>
            </form>
          </div>
        </header>
      )
    }
    ```

    **backoffice/app/(dashboard)/dashboard/page.tsx:**

    ```tsx
    import { getUserRole } from '@/lib/auth'
    import Link from 'next/link'

    export default async function DashboardPage() {
      const role = await getUserRole()
      const isAdmin = role === 'admin'

      return (
        <div>
          <h1 className="text-2xl font-bold text-gray-900 mb-6">
            Bienvenue sur Clickresto
          </h1>

          {isAdmin ? (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <Link
                href="/admin/leads"
                className="block p-6 bg-white rounded-xl shadow-sm border border-gray-200 hover:border-[#E63946] transition-colors"
              >
                <div className="text-3xl mb-3">üìã</div>
                <h2 className="text-lg font-semibold text-gray-900">Leads</h2>
                <p className="text-sm text-gray-600 mt-1">
                  Gerez les demandes de demo
                </p>
              </Link>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <div className="p-6 bg-white rounded-xl shadow-sm border border-gray-200">
                <div className="text-3xl mb-3">üîó</div>
                <h2 className="text-lg font-semibold text-gray-900">Parrainage</h2>
                <p className="text-sm text-gray-600 mt-1">
                  Bientot disponible - Suivez vos parrainages et commissions
                </p>
              </div>
            </div>
          )}
        </div>
      )
    }
    ```
  </action>
  <verify>
    ```bash
    cd backoffice && npm run build
    ```
  </verify>
  <done>
    - Dashboard layout with sidebar and header
    - Role-based navigation (admin sees Leads, affiliate sees future features)
    - User email and logout in header
    - Dashboard home page with quick links
  </done>
</task>

<task type="auto">
  <name>Task 3: Create admin leads page and components</name>
  <files>
    backoffice/app/(dashboard)/admin/leads/page.tsx
    backoffice/components/dashboard/LeadsTable.tsx
    backoffice/components/dashboard/LeadStatusBadge.tsx
  </files>
  <action>
    Create the admin leads management page.

    **backoffice/components/dashboard/LeadStatusBadge.tsx:**

    ```tsx
    import { LeadStatus } from '@/types/database.types'

    const statusConfig: Record<LeadStatus, { label: string; className: string }> = {
      new: {
        label: 'Nouveau',
        className: 'bg-blue-100 text-blue-800',
      },
      contacted: {
        label: 'Contacte',
        className: 'bg-yellow-100 text-yellow-800',
      },
      qualified: {
        label: 'Qualifie',
        className: 'bg-purple-100 text-purple-800',
      },
      converted: {
        label: 'Converti',
        className: 'bg-green-100 text-green-800',
      },
      lost: {
        label: 'Perdu',
        className: 'bg-gray-100 text-gray-800',
      },
    }

    interface LeadStatusBadgeProps {
      status: LeadStatus
    }

    export function LeadStatusBadge({ status }: LeadStatusBadgeProps) {
      const config = statusConfig[status]

      return (
        <span
          className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${config.className}`}
        >
          {config.label}
        </span>
      )
    }
    ```

    **backoffice/components/dashboard/LeadsTable.tsx:**

    ```tsx
    import { Lead } from '@/types/database.types'
    import { LeadStatusBadge } from './LeadStatusBadge'

    interface LeadsTableProps {
      leads: Lead[]
    }

    export function LeadsTable({ leads }: LeadsTableProps) {
      if (leads.length === 0) {
        return (
          <div className="text-center py-12 bg-white rounded-xl">
            <div className="text-4xl mb-4">üì≠</div>
            <h3 className="text-lg font-medium text-gray-900">Aucun lead</h3>
            <p className="text-gray-600 mt-1">
              Les demandes de demo apparaitront ici
            </p>
          </div>
        )
      }

      return (
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Contact
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Restaurant
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Type
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Statut
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Date
                  </th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {leads.map((lead) => (
                  <tr key={lead.id} className="hover:bg-gray-50">
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div>
                        <div className="text-sm font-medium text-gray-900">
                          {lead.first_name} {lead.last_name}
                        </div>
                        <div className="text-sm text-gray-500">{lead.email}</div>
                        {lead.phone && (
                          <div className="text-sm text-gray-500">{lead.phone}</div>
                        )}
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm text-gray-900">{lead.restaurant}</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm text-gray-600 capitalize">
                        {lead.request_type === 'demo' && 'Demo'}
                        {lead.request_type === 'info' && 'Information'}
                        {lead.request_type === 'affiliation' && 'Affiliation'}
                        {lead.request_type === 'autre' && 'Autre'}
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <LeadStatusBadge status={lead.status} />
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {new Date(lead.created_at).toLocaleDateString('fr-FR', {
                        day: 'numeric',
                        month: 'short',
                        year: 'numeric',
                      })}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )
    }
    ```

    **backoffice/app/(dashboard)/admin/leads/page.tsx:**

    ```tsx
    import { createClient } from '@/lib/supabase/server'
    import { requireAdmin } from '@/lib/auth'
    import { LeadsTable } from '@/components/dashboard/LeadsTable'
    import { Lead } from '@/types/database.types'

    export default async function AdminLeadsPage() {
      // Require admin role - redirects if not admin
      await requireAdmin()

      const supabase = await createClient()

      // Fetch all leads (RLS policy ensures only admins can read)
      const { data: leads, error } = await supabase
        .from('leads')
        .select('*')
        .order('created_at', { ascending: false })

      if (error) {
        console.error('Error fetching leads:', error)
        return (
          <div className="text-center py-12">
            <div className="text-4xl mb-4">‚ùå</div>
            <h1 className="text-xl font-medium text-gray-900">
              Erreur de chargement
            </h1>
            <p className="text-gray-600 mt-1">
              Impossible de charger les leads. Veuillez reessayer.
            </p>
          </div>
        )
      }

      const leadCount = leads?.length ?? 0
      const newLeadCount = leads?.filter((l) => l.status === 'new').length ?? 0

      return (
        <div>
          <div className="mb-6">
            <h1 className="text-2xl font-bold text-gray-900">Leads</h1>
            <p className="text-gray-600 mt-1">
              Gerez les demandes de demo et contacts
            </p>
          </div>

          {/* Stats */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div className="bg-white rounded-xl p-4 border border-gray-200">
              <div className="text-sm text-gray-600">Total leads</div>
              <div className="text-2xl font-bold text-gray-900">{leadCount}</div>
            </div>
            <div className="bg-white rounded-xl p-4 border border-gray-200">
              <div className="text-sm text-gray-600">Nouveaux</div>
              <div className="text-2xl font-bold text-blue-600">{newLeadCount}</div>
            </div>
            <div className="bg-white rounded-xl p-4 border border-gray-200">
              <div className="text-sm text-gray-600">Taux conversion</div>
              <div className="text-2xl font-bold text-green-600">
                {leadCount > 0
                  ? Math.round(
                      ((leads?.filter((l) => l.status === 'converted').length ?? 0) /
                        leadCount) *
                        100
                    )
                  : 0}
                %
              </div>
            </div>
          </div>

          {/* Leads table */}
          <LeadsTable leads={(leads as Lead[]) ?? []} />
        </div>
      )
    }
    ```
  </action>
  <verify>
    ```bash
    cd backoffice && npm run build
    ```
  </verify>
  <done>
    - Admin leads page at /admin/leads
    - requireAdmin() protection
    - LeadsTable component with all lead info
    - LeadStatusBadge with French status labels
    - Stats cards (total, new, conversion rate)
    - Empty state handling
    - Error state handling
  </done>
</task>

</tasks>

<verification>
1. `cd backoffice && npm run build` passes
2. Dashboard layout renders with sidebar
3. Sidebar shows different links based on user role
4. Admin leads page requires admin role
5. LeadsTable displays leads with all fields
6. LeadStatusBadge shows colored French labels
7. French text throughout
</verification>

<success_criteria>
- Admin can access /admin/leads
- Non-admin redirected to /dashboard
- Leads table displays: name, email, phone, restaurant, type, status, date
- Status badges with colors (new=blue, contacted=yellow, qualified=purple, converted=green, lost=gray)
- Stats cards show total, new, conversion rate
- Empty state when no leads
- Sidebar navigation based on role
- Logout functionality works
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-lead-capture/01-05-SUMMARY.md`
</output>
