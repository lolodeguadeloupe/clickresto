---
phase: 01-foundation-lead-capture
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - backoffice/app/(auth)/login/page.tsx
  - backoffice/app/(auth)/signup/page.tsx
  - backoffice/app/(auth)/forgot-password/page.tsx
  - backoffice/app/(auth)/auth/callback/route.ts
  - backoffice/app/actions/auth.ts
  - backoffice/components/auth/LoginForm.tsx
  - backoffice/components/auth/SignupForm.tsx
autonomous: true

must_haves:
  truths:
    - "User can sign up with email and password"
    - "User can log in with email and password"
    - "User can request magic link and log in via email link"
    - "User can request password reset and receive email"
  artifacts:
    - path: "backoffice/app/(auth)/login/page.tsx"
      provides: "Login page with email/password and magic link options"
      min_lines: 20
    - path: "backoffice/app/(auth)/signup/page.tsx"
      provides: "Signup page with email/password"
      min_lines: 20
    - path: "backoffice/app/(auth)/forgot-password/page.tsx"
      provides: "Password reset request page"
      min_lines: 15
    - path: "backoffice/app/(auth)/auth/callback/route.ts"
      provides: "OAuth/magic link callback handler"
      exports: ["GET"]
    - path: "backoffice/app/actions/auth.ts"
      provides: "Server actions for auth operations"
      contains: ["signUp", "signIn", "signInWithOtp", "resetPassword"]
  key_links:
    - from: "backoffice/app/(auth)/login/page.tsx"
      to: "backoffice/app/actions/auth.ts"
      via: "form action"
      pattern: "action=.*signIn"
    - from: "backoffice/app/(auth)/auth/callback/route.ts"
      to: "Supabase Auth"
      via: "verifyOtp"
      pattern: "verifyOtp"
---

<objective>
Implement complete authentication system with email/password, magic link, and password reset flows.

Purpose: Enable users (admin and affiliates) to securely access the back-office with multiple authentication methods (AUTH-01, AUTH-02, AUTH-03).
Output: Working login, signup, magic link, and password reset pages with Server Actions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-lead-capture/01-RESEARCH.md
@.planning/phases/01-foundation-lead-capture/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth Server Actions</name>
  <files>
    backoffice/app/actions/auth.ts
  </files>
  <action>
    Create `backoffice/app/actions/auth.ts` with Server Actions for all auth flows:

    ```typescript
    'use server'

    import { createClient } from '@/lib/supabase/server'
    import { redirect } from 'next/navigation'
    import { z } from 'zod'

    const signUpSchema = z.object({
      email: z.string().email('Email invalide'),
      password: z.string().min(8, 'Le mot de passe doit contenir au moins 8 caracteres'),
    })

    const signInSchema = z.object({
      email: z.string().email('Email invalide'),
      password: z.string().min(1, 'Mot de passe requis'),
    })

    const magicLinkSchema = z.object({
      email: z.string().email('Email invalide'),
    })

    export async function signUp(formData: FormData) {
      const parsed = signUpSchema.safeParse({
        email: formData.get('email'),
        password: formData.get('password'),
      })

      if (!parsed.success) {
        return { error: parsed.error.flatten().fieldErrors }
      }

      const supabase = await createClient()

      const { error } = await supabase.auth.signUp({
        email: parsed.data.email,
        password: parsed.data.password,
        options: {
          emailRedirectTo: `${process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'}/auth/callback`,
        },
      })

      if (error) {
        return { error: { _form: [error.message] } }
      }

      return { success: 'Verifiez votre email pour confirmer votre compte' }
    }

    export async function signIn(formData: FormData) {
      const parsed = signInSchema.safeParse({
        email: formData.get('email'),
        password: formData.get('password'),
      })

      if (!parsed.success) {
        return { error: parsed.error.flatten().fieldErrors }
      }

      const supabase = await createClient()

      const { error } = await supabase.auth.signInWithPassword({
        email: parsed.data.email,
        password: parsed.data.password,
      })

      if (error) {
        return { error: { _form: ['Email ou mot de passe incorrect'] } }
      }

      redirect('/dashboard')
    }

    export async function signInWithOtp(formData: FormData) {
      const parsed = magicLinkSchema.safeParse({
        email: formData.get('email'),
      })

      if (!parsed.success) {
        return { error: parsed.error.flatten().fieldErrors }
      }

      const supabase = await createClient()

      const { error } = await supabase.auth.signInWithOtp({
        email: parsed.data.email,
        options: {
          emailRedirectTo: `${process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'}/auth/callback`,
          shouldCreateUser: false, // Don't auto-create users with magic link
        },
      })

      if (error) {
        return { error: { _form: [error.message] } }
      }

      return { success: 'Lien de connexion envoye par email' }
    }

    export async function resetPassword(formData: FormData) {
      const parsed = magicLinkSchema.safeParse({
        email: formData.get('email'),
      })

      if (!parsed.success) {
        return { error: parsed.error.flatten().fieldErrors }
      }

      const supabase = await createClient()

      const { error } = await supabase.auth.resetPasswordForEmail(parsed.data.email, {
        redirectTo: `${process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'}/auth/callback?type=recovery`,
      })

      if (error) {
        return { error: { _form: [error.message] } }
      }

      return { success: 'Email de reinitialisation envoye' }
    }

    export async function signOut() {
      const supabase = await createClient()
      await supabase.auth.signOut()
      redirect('/login')
    }
    ```

    NOTE: All user-facing text is in French. Validation uses Zod schemas. redirectTo URLs use environment variable with localhost fallback.
  </action>
  <verify>
    ```bash
    cd backoffice && npx tsc --noEmit
    ```
    TypeScript compilation should pass.
  </verify>
  <done>
    - app/actions/auth.ts exists
    - Exports signUp, signIn, signInWithOtp, resetPassword, signOut
    - Uses Zod for validation
    - French error messages
    - Proper redirect URLs
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth callback route</name>
  <files>
    backoffice/app/(auth)/auth/callback/route.ts
  </files>
  <action>
    Create `backoffice/app/(auth)/auth/callback/route.ts` to handle magic link and password reset callbacks:

    ```typescript
    import { createClient } from '@/lib/supabase/server'
    import { NextResponse } from 'next/server'

    export async function GET(request: Request) {
      const { searchParams, origin } = new URL(request.url)
      const token_hash = searchParams.get('token_hash')
      const type = searchParams.get('type') as 'magiclink' | 'recovery' | 'email' | null
      const next = searchParams.get('next') ?? '/dashboard'

      if (token_hash && type) {
        const supabase = await createClient()

        const { error } = await supabase.auth.verifyOtp({
          type,
          token_hash,
        })

        if (!error) {
          // For password recovery, redirect to update password page
          if (type === 'recovery') {
            return NextResponse.redirect(`${origin}/update-password`)
          }
          return NextResponse.redirect(`${origin}${next}`)
        }
      }

      // Redirect to login with error
      return NextResponse.redirect(`${origin}/login?error=invalid_link`)
    }
    ```

    Create also `backoffice/app/(auth)/update-password/page.tsx` for password recovery:

    ```tsx
    'use client'

    import { useState } from 'react'
    import { createClient } from '@/lib/supabase/client'
    import { useRouter } from 'next/navigation'

    export default function UpdatePasswordPage() {
      const [password, setPassword] = useState('')
      const [confirmPassword, setConfirmPassword] = useState('')
      const [error, setError] = useState('')
      const [loading, setLoading] = useState(false)
      const router = useRouter()

      const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault()
        setError('')

        if (password !== confirmPassword) {
          setError('Les mots de passe ne correspondent pas')
          return
        }

        if (password.length < 8) {
          setError('Le mot de passe doit contenir au moins 8 caracteres')
          return
        }

        setLoading(true)
        const supabase = createClient()

        const { error } = await supabase.auth.updateUser({
          password: password,
        })

        if (error) {
          setError(error.message)
          setLoading(false)
          return
        }

        router.push('/dashboard')
      }

      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-50">
          <div className="max-w-md w-full space-y-8 p-8 bg-white rounded-lg shadow">
            <h2 className="text-2xl font-bold text-center text-gray-900">
              Nouveau mot de passe
            </h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              {error && (
                <div className="bg-red-50 text-red-600 p-3 rounded">
                  {error}
                </div>
              )}
              <div>
                <label htmlFor="password" className="block text-sm font-medium text-gray-700">
                  Nouveau mot de passe
                </label>
                <input
                  id="password"
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  minLength={8}
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"
                />
              </div>
              <div>
                <label htmlFor="confirmPassword" className="block text-sm font-medium text-gray-700">
                  Confirmer le mot de passe
                </label>
                <input
                  id="confirmPassword"
                  type="password"
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  required
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"
                />
              </div>
              <button
                type="submit"
                disabled={loading}
                className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:opacity-50"
              >
                {loading ? 'Mise a jour...' : 'Mettre a jour le mot de passe'}
              </button>
            </form>
          </div>
        </div>
      )
    }
    ```
  </action>
  <verify>
    ```bash
    cd backoffice && npx tsc --noEmit
    ```
  </verify>
  <done>
    - app/(auth)/auth/callback/route.ts handles magic link and recovery
    - app/(auth)/update-password/page.tsx allows password update
    - Proper redirects based on auth type
  </done>
</task>

<task type="auto">
  <name>Task 3: Create login and signup pages</name>
  <files>
    backoffice/app/(auth)/login/page.tsx
    backoffice/app/(auth)/signup/page.tsx
    backoffice/app/(auth)/forgot-password/page.tsx
    backoffice/app/(auth)/layout.tsx
  </files>
  <action>
    Create auth layout `backoffice/app/(auth)/layout.tsx`:

    ```tsx
    export default function AuthLayout({
      children,
    }: {
      children: React.ReactNode
    }) {
      return (
        <div className="min-h-screen flex items-center justify-center bg-[#F1FAEE]">
          <div className="max-w-md w-full mx-4">
            {children}
          </div>
        </div>
      )
    }
    ```

    Create `backoffice/app/(auth)/login/page.tsx`:

    ```tsx
    'use client'

    import { useState } from 'react'
    import { signIn, signInWithOtp } from '@/app/actions/auth'
    import Link from 'next/link'
    import { useSearchParams } from 'next/navigation'

    export default function LoginPage() {
      const [mode, setMode] = useState<'password' | 'magic'>('password')
      const [error, setError] = useState('')
      const [success, setSuccess] = useState('')
      const [loading, setLoading] = useState(false)
      const searchParams = useSearchParams()
      const urlError = searchParams.get('error')

      const handleSubmit = async (formData: FormData) => {
        setError('')
        setSuccess('')
        setLoading(true)

        const action = mode === 'password' ? signIn : signInWithOtp
        const result = await action(formData)

        if (result?.error) {
          if (typeof result.error === 'object' && '_form' in result.error) {
            setError(result.error._form?.[0] || 'Une erreur est survenue')
          } else {
            setError('Une erreur est survenue')
          }
        }

        if (result?.success) {
          setSuccess(result.success)
        }

        setLoading(false)
      }

      return (
        <div className="bg-white rounded-2xl shadow-xl p-8">
          <div className="text-center mb-8">
            <h1 className="text-3xl font-bold text-[#1D3557]">Clickresto</h1>
            <p className="text-gray-600 mt-2">Connectez-vous a votre espace</p>
          </div>

          {urlError === 'invalid_link' && (
            <div className="bg-red-50 text-red-600 p-3 rounded-lg mb-4">
              Le lien de connexion est invalide ou a expire
            </div>
          )}

          {error && (
            <div className="bg-red-50 text-red-600 p-3 rounded-lg mb-4">
              {error}
            </div>
          )}

          {success && (
            <div className="bg-green-50 text-green-600 p-3 rounded-lg mb-4">
              {success}
            </div>
          )}

          <div className="flex mb-6 bg-gray-100 rounded-lg p-1">
            <button
              type="button"
              onClick={() => setMode('password')}
              className={`flex-1 py-2 text-sm font-medium rounded-md transition-colors ${
                mode === 'password'
                  ? 'bg-white text-[#1D3557] shadow'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              Mot de passe
            </button>
            <button
              type="button"
              onClick={() => setMode('magic')}
              className={`flex-1 py-2 text-sm font-medium rounded-md transition-colors ${
                mode === 'magic'
                  ? 'bg-white text-[#1D3557] shadow'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              Lien magique
            </button>
          </div>

          <form action={handleSubmit} className="space-y-4">
            <div>
              <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">
                Email
              </label>
              <input
                id="email"
                name="email"
                type="email"
                required
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E63946] focus:border-transparent"
                placeholder="vous@restaurant.fr"
              />
            </div>

            {mode === 'password' && (
              <div>
                <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">
                  Mot de passe
                </label>
                <input
                  id="password"
                  name="password"
                  type="password"
                  required
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E63946] focus:border-transparent"
                  placeholder="Votre mot de passe"
                />
              </div>
            )}

            <button
              type="submit"
              disabled={loading}
              className="w-full py-3 bg-[#E63946] text-white font-semibold rounded-lg hover:bg-[#c41e2d] transition-colors disabled:opacity-50"
            >
              {loading
                ? 'Chargement...'
                : mode === 'password'
                ? 'Se connecter'
                : 'Envoyer le lien'}
            </button>
          </form>

          <div className="mt-6 text-center space-y-2">
            {mode === 'password' && (
              <Link
                href="/forgot-password"
                className="text-sm text-[#E63946] hover:underline block"
              >
                Mot de passe oublie ?
              </Link>
            )}
            <p className="text-sm text-gray-600">
              Pas encore de compte ?{' '}
              <Link href="/signup" className="text-[#E63946] hover:underline font-medium">
                S'inscrire
              </Link>
            </p>
          </div>
        </div>
      )
    }
    ```

    Create `backoffice/app/(auth)/signup/page.tsx`:

    ```tsx
    'use client'

    import { useState } from 'react'
    import { signUp } from '@/app/actions/auth'
    import Link from 'next/link'

    export default function SignupPage() {
      const [error, setError] = useState('')
      const [success, setSuccess] = useState('')
      const [loading, setLoading] = useState(false)

      const handleSubmit = async (formData: FormData) => {
        setError('')
        setSuccess('')
        setLoading(true)

        const result = await signUp(formData)

        if (result?.error) {
          if (typeof result.error === 'object' && '_form' in result.error) {
            setError(result.error._form?.[0] || 'Une erreur est survenue')
          } else if (typeof result.error === 'object') {
            const firstError = Object.values(result.error).flat()[0]
            setError(firstError || 'Une erreur est survenue')
          }
        }

        if (result?.success) {
          setSuccess(result.success)
        }

        setLoading(false)
      }

      return (
        <div className="bg-white rounded-2xl shadow-xl p-8">
          <div className="text-center mb-8">
            <h1 className="text-3xl font-bold text-[#1D3557]">Clickresto</h1>
            <p className="text-gray-600 mt-2">Creez votre compte</p>
          </div>

          {error && (
            <div className="bg-red-50 text-red-600 p-3 rounded-lg mb-4">
              {error}
            </div>
          )}

          {success && (
            <div className="bg-green-50 text-green-600 p-3 rounded-lg mb-4">
              {success}
            </div>
          )}

          <form action={handleSubmit} className="space-y-4">
            <div>
              <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">
                Email
              </label>
              <input
                id="email"
                name="email"
                type="email"
                required
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E63946] focus:border-transparent"
                placeholder="vous@restaurant.fr"
              />
            </div>

            <div>
              <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">
                Mot de passe
              </label>
              <input
                id="password"
                name="password"
                type="password"
                required
                minLength={8}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E63946] focus:border-transparent"
                placeholder="Minimum 8 caracteres"
              />
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full py-3 bg-[#E63946] text-white font-semibold rounded-lg hover:bg-[#c41e2d] transition-colors disabled:opacity-50"
            >
              {loading ? 'Chargement...' : 'Creer mon compte'}
            </button>
          </form>

          <p className="mt-6 text-center text-sm text-gray-600">
            Deja un compte ?{' '}
            <Link href="/login" className="text-[#E63946] hover:underline font-medium">
              Se connecter
            </Link>
          </p>
        </div>
      )
    }
    ```

    Create `backoffice/app/(auth)/forgot-password/page.tsx`:

    ```tsx
    'use client'

    import { useState } from 'react'
    import { resetPassword } from '@/app/actions/auth'
    import Link from 'next/link'

    export default function ForgotPasswordPage() {
      const [error, setError] = useState('')
      const [success, setSuccess] = useState('')
      const [loading, setLoading] = useState(false)

      const handleSubmit = async (formData: FormData) => {
        setError('')
        setSuccess('')
        setLoading(true)

        const result = await resetPassword(formData)

        if (result?.error) {
          if (typeof result.error === 'object' && '_form' in result.error) {
            setError(result.error._form?.[0] || 'Une erreur est survenue')
          }
        }

        if (result?.success) {
          setSuccess(result.success)
        }

        setLoading(false)
      }

      return (
        <div className="bg-white rounded-2xl shadow-xl p-8">
          <div className="text-center mb-8">
            <h1 className="text-3xl font-bold text-[#1D3557]">Clickresto</h1>
            <p className="text-gray-600 mt-2">Reinitialiser votre mot de passe</p>
          </div>

          {error && (
            <div className="bg-red-50 text-red-600 p-3 rounded-lg mb-4">
              {error}
            </div>
          )}

          {success && (
            <div className="bg-green-50 text-green-600 p-3 rounded-lg mb-4">
              {success}
            </div>
          )}

          <form action={handleSubmit} className="space-y-4">
            <div>
              <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">
                Email
              </label>
              <input
                id="email"
                name="email"
                type="email"
                required
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E63946] focus:border-transparent"
                placeholder="vous@restaurant.fr"
              />
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full py-3 bg-[#E63946] text-white font-semibold rounded-lg hover:bg-[#c41e2d] transition-colors disabled:opacity-50"
            >
              {loading ? 'Envoi...' : 'Envoyer le lien de reinitialisation'}
            </button>
          </form>

          <p className="mt-6 text-center text-sm text-gray-600">
            <Link href="/login" className="text-[#E63946] hover:underline font-medium">
              Retour a la connexion
            </Link>
          </p>
        </div>
      )
    }
    ```
  </action>
  <verify>
    ```bash
    cd backoffice && npm run build
    ```
    Build should pass without errors.
  </verify>
  <done>
    - Login page with email/password and magic link toggle
    - Signup page with email/password
    - Forgot password page with reset link
    - Auth layout with Clickresto branding
    - All pages use French text
    - Colors match Clickresto design system
  </done>
</task>

</tasks>

<verification>
1. `cd backoffice && npm run build` passes
2. Login page accessible at /login
3. Signup page accessible at /signup
4. Forgot password page accessible at /forgot-password
5. All forms call correct Server Actions
6. Error and success messages display correctly
</verification>

<success_criteria>
- User can navigate to /login and see login form
- Login form has email/password and magic link modes
- User can navigate to /signup and see signup form
- User can navigate to /forgot-password and see reset form
- All forms submit via Server Actions with Zod validation
- French language for all user-facing text
- Clickresto brand colors applied
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-lead-capture/01-02-SUMMARY.md`
</output>
