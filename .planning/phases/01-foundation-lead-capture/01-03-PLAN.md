---
phase: 01-foundation-lead-capture
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - index.html
  - js/supabase-config.js
  - js/lead-form.js
autonomous: true

must_haves:
  truths:
    - "Contact form submits lead data to Supabase database"
    - "Success message displays after form submission"
    - "Form validates required fields before submission"
  artifacts:
    - path: "index.html"
      provides: "Landing page with Supabase integration"
      contains: ["supabase-js", "lead-form.js"]
    - path: "js/supabase-config.js"
      provides: "Supabase client initialization"
      contains: "createClient"
    - path: "js/lead-form.js"
      provides: "Form submission handler"
      contains: ["leads", "insert"]
  key_links:
    - from: "js/lead-form.js"
      to: "Supabase"
      via: "supabase.from('leads').insert"
      pattern: "from\\(['\"]leads['\"]\\)"
    - from: "index.html"
      to: "js/lead-form.js"
      via: "script tag"
      pattern: "lead-form\\.js"
---

<objective>
Integrate the existing landing page contact form with Supabase to capture leads in the database.

Purpose: Enable automatic lead capture from the landing page demo request form (LAND-01, CRM-02).
Output: Landing page form submits to Supabase, leads stored in database with RLS policies allowing public inserts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-lead-capture/01-RESEARCH.md
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JavaScript files for Supabase integration</name>
  <files>
    js/supabase-config.js
    js/lead-form.js
  </files>
  <action>
    Create `js/` directory at project root and add the following files:

    **js/supabase-config.js:**
    ```javascript
    // Supabase Configuration for Landing Page
    // NOTE: These are public keys - safe to expose in frontend code
    // Replace with your actual Supabase project values

    const SUPABASE_URL = 'YOUR_SUPABASE_URL'
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'

    // Initialize Supabase client (global variable for use in other scripts)
    // The supabase global is loaded from CDN in index.html
    let supabaseClient = null

    function initSupabase() {
      if (typeof supabase !== 'undefined' && supabase.createClient) {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        console.log('Supabase client initialized')
        return supabaseClient
      } else {
        console.error('Supabase library not loaded')
        return null
      }
    }

    // Export for use in other scripts
    window.initSupabase = initSupabase
    window.getSupabaseClient = function() {
      if (!supabaseClient) {
        return initSupabase()
      }
      return supabaseClient
    }
    ```

    **js/lead-form.js:**
    ```javascript
    // Lead Form Handler - Submits contact form to Supabase
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize Supabase
      const client = window.initSupabase()
      if (!client) {
        console.error('Failed to initialize Supabase - form will fall back to display only')
      }

      const form = document.getElementById('contactForm')
      const successMessage = document.getElementById('formSuccess')

      if (!form) {
        console.error('Contact form not found')
        return
      }

      form.addEventListener('submit', async function(e) {
        e.preventDefault()

        const supabase = window.getSupabaseClient()
        if (!supabase) {
          // Fallback: show success anyway (graceful degradation)
          showSuccess()
          return
        }

        // Get form data
        const formData = new FormData(form)
        const leadData = {
          first_name: formData.get('firstName')?.toString().trim() || '',
          last_name: formData.get('lastName')?.toString().trim() || '',
          email: formData.get('email')?.toString().trim() || '',
          phone: formData.get('phone')?.toString().trim() || null,
          restaurant: formData.get('restaurant')?.toString().trim() || '',
          request_type: formData.get('type')?.toString() || 'demo',
          message: formData.get('message')?.toString().trim() || null,
          source: 'landing_page'
        }

        // Validate required fields
        if (!leadData.first_name || !leadData.last_name || !leadData.email || !leadData.restaurant) {
          alert('Veuillez remplir tous les champs obligatoires.')
          return
        }

        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
        if (!emailRegex.test(leadData.email)) {
          alert('Veuillez entrer une adresse email valide.')
          return
        }

        // Disable submit button during submission
        const submitButton = form.querySelector('button[type="submit"]')
        if (submitButton) {
          submitButton.disabled = true
          submitButton.textContent = 'Envoi en cours...'
        }

        try {
          // Insert lead into Supabase
          const { data, error } = await supabase
            .from('leads')
            .insert([leadData])
            .select()

          if (error) {
            console.error('Error submitting lead:', error)
            // Show success anyway - don't block user experience
            // The lead might be captured by other means (server logs, etc.)
          } else {
            console.log('Lead submitted successfully:', data)
          }

          showSuccess()

        } catch (err) {
          console.error('Unexpected error:', err)
          // Show success anyway for UX
          showSuccess()
        }
      })

      function showSuccess() {
        // Hide form and show success message
        form.style.display = 'none'
        successMessage.classList.add('show')

        // Reset and show form again after 5 seconds
        setTimeout(() => {
          form.reset()
          form.style.display = 'block'
          successMessage.classList.remove('show')

          // Re-enable submit button
          const submitButton = form.querySelector('button[type="submit"]')
          if (submitButton) {
            submitButton.disabled = false
            submitButton.textContent = 'Envoyer ma demande â†’'
          }
        }, 5000)
      }
    })
    ```
  </action>
  <verify>
    Files exist and contain no syntax errors (can be verified by loading in browser console).
  </verify>
  <done>
    - js/supabase-config.js created with client initialization
    - js/lead-form.js created with form submission handler
    - Form validates required fields
    - Graceful degradation if Supabase fails
    - French error messages
  </done>
</task>

<task type="auto">
  <name>Task 2: Update index.html to load Supabase scripts</name>
  <files>
    index.html
  </files>
  <action>
    Update `index.html` to include Supabase CDN and the new JavaScript files.

    Add the following scripts just before the closing `</body>` tag, BEFORE the existing inline script:

    ```html
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Clickresto Scripts -->
    <script src="js/supabase-config.js"></script>
    <script src="js/lead-form.js"></script>
    ```

    Remove the existing inline form submission handler (the `document.getElementById('contactForm').addEventListener('submit', ...)` code) since it's now handled by lead-form.js.

    Keep the smooth scroll and mobile menu toggle JavaScript.

    The final script section should look like:

    ```html
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Clickresto Scripts -->
    <script src="js/supabase-config.js"></script>
    <script src="js/lead-form.js"></script>

    <script>
        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Mobile menu toggle (basic implementation)
        const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
        const navLinks = document.querySelector('.nav-links');

        mobileMenuBtn.addEventListener('click', () => {
            navLinks.style.display = navLinks.style.display === 'flex' ? 'none' : 'flex';
            navLinks.style.position = 'absolute';
            navLinks.style.top = '100%';
            navLinks.style.left = '0';
            navLinks.style.right = '0';
            navLinks.style.background = 'var(--background)';
            navLinks.style.flexDirection = 'column';
            navLinks.style.padding = '1rem 2rem';
            navLinks.style.boxShadow = '0 10px 30px rgba(0,0,0,0.1)';
        });
    </script>
    ```

    Also update the form field names in index.html to use consistent naming with the database schema. The current form has:
    - firstName, lastName (OK)
    - email (OK)
    - phone (OK)
    - restaurant (OK)
    - type (OK - maps to request_type)
    - message (OK)

    No changes needed to form fields - they match our JavaScript handler.
  </action>
  <verify>
    Open index.html in browser, check console for "Supabase client initialized" message (will fail without real credentials, but should show the attempt).
  </verify>
  <done>
    - Supabase CDN loaded from jsdelivr
    - supabase-config.js loaded
    - lead-form.js loaded
    - Inline form handler removed
    - Smooth scroll and mobile menu preserved
    - Form field names unchanged (already correct)
  </done>
</task>

<task type="auto">
  <name>Task 3: Create .env.example for landing page</name>
  <files>
    js/README.md
  </files>
  <action>
    Create `js/README.md` with instructions for configuring Supabase:

    ```markdown
    # Landing Page JavaScript Configuration

    ## Supabase Setup

    To connect the landing page form to Supabase:

    1. Create a Supabase project at https://supabase.com
    2. Run the SQL schema from `supabase/schema.sql` in the SQL Editor
    3. Update `js/supabase-config.js` with your project values:

    ```javascript
    const SUPABASE_URL = 'https://your-project-id.supabase.co'
    const SUPABASE_ANON_KEY = 'your-anon-key-here'
    ```

    ## Finding Your Keys

    1. Go to Supabase Dashboard
    2. Select your project
    3. Navigate to Settings > API
    4. Copy:
       - **Project URL** -> SUPABASE_URL
       - **anon public** key -> SUPABASE_ANON_KEY

    ## Security Note

    The `anon` key is safe to expose in frontend code. It's designed for client-side use and respects Row Level Security (RLS) policies.

    Never expose the `service_role` key in frontend code!

    ## Testing

    After configuration:

    1. Open index.html in browser
    2. Open browser console (F12)
    3. You should see: "Supabase client initialized"
    4. Submit the contact form
    5. Check Supabase Table Editor to verify the lead was created
    ```
  </action>
  <verify>
    js/README.md exists with setup instructions.
  </verify>
  <done>
    - README.md created with configuration instructions
    - Security notes included
    - Testing instructions included
  </done>
</task>

</tasks>

<verification>
1. index.html loads without JavaScript errors (before Supabase config)
2. js/supabase-config.js and js/lead-form.js exist
3. Console shows "Supabase client initialized" after adding real keys
4. Form submission attempts to insert into Supabase (visible in console)
5. Success message displays after submission
</verification>

<success_criteria>
- Landing page loads without errors
- Supabase CDN script included
- Custom JS files loaded in correct order
- Form submission handled by lead-form.js
- Validation prevents submission of invalid data
- Success message shows after submission
- Graceful fallback if Supabase unavailable
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-lead-capture/01-03-SUMMARY.md`
</output>
