---
phase: 01-foundation-lead-capture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backoffice/package.json
  - backoffice/app/layout.tsx
  - backoffice/lib/supabase/server.ts
  - backoffice/lib/supabase/client.ts
  - backoffice/middleware.ts
  - backoffice/.env.local.example
  - supabase/schema.sql
autonomous: true
user_setup:
  - service: supabase
    why: "Database and authentication backend"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon public key"
    dashboard_config:
      - task: "Create a new Supabase project"
        location: "https://supabase.com/dashboard -> New Project"

must_haves:
  truths:
    - "Next.js back-office app runs locally on port 3000"
    - "Supabase client can connect to database"
    - "Database schema includes users, user_roles, and leads tables"
  artifacts:
    - path: "backoffice/package.json"
      provides: "Next.js project configuration"
      contains: "@supabase/ssr"
    - path: "backoffice/lib/supabase/server.ts"
      provides: "Server-side Supabase client"
      exports: ["createClient"]
    - path: "backoffice/lib/supabase/client.ts"
      provides: "Client-side Supabase client"
      exports: ["createClient"]
    - path: "backoffice/middleware.ts"
      provides: "Session refresh middleware"
      contains: "supabase.auth.getUser"
    - path: "supabase/schema.sql"
      provides: "Database schema with RLS"
      contains: ["user_roles", "leads"]
  key_links:
    - from: "backoffice/middleware.ts"
      to: "Supabase Auth"
      via: "createServerClient"
      pattern: "createServerClient"
    - from: "backoffice/lib/supabase/server.ts"
      to: "cookies"
      via: "Next.js cookies() API"
      pattern: "cookies\\(\\)"
---

<objective>
Set up Next.js back-office application with Supabase integration and database schema.

Purpose: Create the foundation for the entire Phase 1 - authentication, admin dashboard, and lead management all depend on this infrastructure.
Output: Working Next.js app with Supabase client configured, database schema ready for deployment.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-lead-capture/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Next.js app with Supabase template</name>
  <files>
    backoffice/package.json
    backoffice/app/layout.tsx
    backoffice/app/page.tsx
    backoffice/lib/supabase/server.ts
    backoffice/lib/supabase/client.ts
    backoffice/middleware.ts
    backoffice/.env.local.example
    backoffice/tsconfig.json
  </files>
  <action>
    Create Next.js 15 app in `backoffice/` directory using the Supabase template:

    ```bash
    npx create-next-app@latest backoffice -e with-supabase --typescript --tailwind --eslint --app --src-dir=false --import-alias="@/*"
    ```

    After creation, verify/update the following files:

    1. `lib/supabase/server.ts` - Server client with cookie handling (pattern from RESEARCH.md)
    2. `lib/supabase/client.ts` - Browser client using createBrowserClient
    3. `middleware.ts` - Session refresh middleware (CRITICAL: must call getUser() to refresh tokens)

    Create `.env.local.example` with placeholder values:
    ```
    NEXT_PUBLIC_SUPABASE_URL=your-project-url
    NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
    ```

    Install additional dependencies:
    ```bash
    cd backoffice && npm install zod
    ```

    Update `app/page.tsx` to show a simple "Clickresto Back-Office" heading with link to /login.
  </action>
  <verify>
    ```bash
    cd backoffice && npm run build
    ```
    Build should complete without errors.
  </verify>
  <done>
    - backoffice/ directory exists with Next.js 15 app
    - @supabase/ssr in dependencies
    - lib/supabase/server.ts and client.ts exist
    - middleware.ts exists with session refresh
    - Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create database schema with RLS policies</name>
  <files>
    supabase/schema.sql
  </files>
  <action>
    Create `supabase/schema.sql` at project root with the following schema:

    ```sql
    -- User roles table (admin or affiliate)
    create table public.user_roles (
      user_id uuid references auth.users on delete cascade primary key,
      role text not null check (role in ('admin', 'affiliate')),
      created_at timestamp with time zone default timezone('utc'::text, now()) not null
    );

    -- Enable RLS on user_roles
    alter table public.user_roles enable row level security;

    -- Users can read their own role
    create policy "Users can read own role"
      on public.user_roles
      for select
      using (auth.uid() = user_id);

    -- Leads table for demo requests
    create table public.leads (
      id uuid default gen_random_uuid() primary key,
      first_name text not null,
      last_name text not null,
      email text not null,
      phone text,
      restaurant text not null,
      request_type text not null default 'demo',
      message text,
      status text not null default 'new' check (status in ('new', 'contacted', 'qualified', 'converted', 'lost')),
      source text default 'landing_page',
      affiliate_id uuid references auth.users(id),
      created_at timestamp with time zone default timezone('utc'::text, now()) not null,
      updated_at timestamp with time zone default timezone('utc'::text, now()) not null
    );

    -- Enable RLS on leads
    alter table public.leads enable row level security;

    -- Anyone can insert leads (public form submission)
    create policy "Anyone can insert leads"
      on public.leads
      for insert
      with check (true);

    -- Only admins can read all leads
    create policy "Admins can read all leads"
      on public.leads
      for select
      using (
        exists (
          select 1 from public.user_roles
          where user_id = (select auth.uid())
          and role = 'admin'
        )
      );

    -- Only admins can update leads
    create policy "Admins can update leads"
      on public.leads
      for update
      using (
        exists (
          select 1 from public.user_roles
          where user_id = (select auth.uid())
          and role = 'admin'
        )
      );

    -- Trigger to auto-assign affiliate role to new users
    create or replace function public.handle_new_user()
    returns trigger
    language plpgsql
    security definer set search_path = public
    as $$
    begin
      insert into public.user_roles (user_id, role)
      values (new.id, 'affiliate');
      return new;
    end;
    $$;

    create trigger on_auth_user_created
      after insert on auth.users
      for each row execute procedure public.handle_new_user();

    -- Function to update updated_at timestamp
    create or replace function public.update_updated_at_column()
    returns trigger
    language plpgsql
    as $$
    begin
      new.updated_at = timezone('utc'::text, now());
      return new;
    end;
    $$;

    create trigger update_leads_updated_at
      before update on public.leads
      for each row execute procedure public.update_updated_at_column();

    -- Index for RLS performance (wrap auth.uid() for optimizer)
    create index user_roles_user_id_idx on public.user_roles(user_id);
    create index leads_status_idx on public.leads(status);
    create index leads_created_at_idx on public.leads(created_at desc);
    ```

    NOTE: This SQL should be run in Supabase SQL Editor. The schema includes:
    - RLS policies optimized per RESEARCH.md (using subquery for auth.uid())
    - Indexes on columns used in RLS policies
    - Auto-role assignment trigger (new users get 'affiliate' role)
    - Updated_at trigger for leads
  </action>
  <verify>
    File exists and contains valid SQL syntax. Manual verification: user should run this in Supabase SQL Editor.
  </verify>
  <done>
    - supabase/schema.sql exists at project root
    - Contains user_roles table with RLS
    - Contains leads table with RLS
    - Contains trigger for auto-role assignment
    - Contains indexes for RLS performance
  </done>
</task>

<task type="auto">
  <name>Task 3: Create TypeScript types for database</name>
  <files>
    backoffice/types/database.types.ts
  </files>
  <action>
    Create TypeScript types matching the database schema. Create `backoffice/types/database.types.ts`:

    ```typescript
    export type UserRole = 'admin' | 'affiliate'

    export type LeadStatus = 'new' | 'contacted' | 'qualified' | 'converted' | 'lost'

    export type RequestType = 'demo' | 'info' | 'affiliation' | 'autre'

    export interface UserRoleRow {
      user_id: string
      role: UserRole
      created_at: string
    }

    export interface Lead {
      id: string
      first_name: string
      last_name: string
      email: string
      phone: string | null
      restaurant: string
      request_type: RequestType
      message: string | null
      status: LeadStatus
      source: string | null
      affiliate_id: string | null
      created_at: string
      updated_at: string
    }

    export interface LeadInsert {
      first_name: string
      last_name: string
      email: string
      phone?: string | null
      restaurant: string
      request_type?: RequestType
      message?: string | null
      source?: string | null
      affiliate_id?: string | null
    }

    export interface Database {
      public: {
        Tables: {
          user_roles: {
            Row: UserRoleRow
            Insert: Omit<UserRoleRow, 'created_at'>
            Update: Partial<Omit<UserRoleRow, 'user_id' | 'created_at'>>
          }
          leads: {
            Row: Lead
            Insert: LeadInsert
            Update: Partial<Omit<Lead, 'id' | 'created_at' | 'updated_at'>>
          }
        }
      }
    }
    ```
  </action>
  <verify>
    ```bash
    cd backoffice && npx tsc --noEmit
    ```
    TypeScript compilation should pass.
  </verify>
  <done>
    - types/database.types.ts exists
    - Exports UserRole, LeadStatus, Lead, LeadInsert types
    - Exports Database type for Supabase client typing
  </done>
</task>

</tasks>

<verification>
1. `cd backoffice && npm run build` passes
2. `cd backoffice && npx tsc --noEmit` passes
3. supabase/schema.sql contains valid SQL
4. All required files exist with correct exports
</verification>

<success_criteria>
- Next.js back-office app created and builds successfully
- Supabase client files configured for both server and client components
- Middleware configured for session refresh
- Database schema SQL ready for deployment
- TypeScript types defined for database tables
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-lead-capture/01-01-SUMMARY.md`
</output>
